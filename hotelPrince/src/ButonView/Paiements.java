/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JInternalFrame.java to edit this template
 */
package ButonView;

import java.sql.*;
import javax.swing.JOptionPane;
import static DataBase.ConnectionBd.*;
import java.util.HashMap;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JRootPane;
import javax.swing.plaf.basic.BasicInternalFrameUI;
import net.sf.jasperreports.engine.JasperCompileManager;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;
import net.sf.jasperreports.engine.design.JasperDesign;
import net.sf.jasperreports.engine.xml.JRXmlLoader;
import net.sf.jasperreports.view.JasperViewer;

/**
 *
 * @author prince
 */
public class Paiements extends javax.swing.JInternalFrame {

    /**
     * Creates new form Paiements
     */
    PreparedStatement ps;
    ResultSet rs;

    public Paiements() {
        initComponents();
        Connect();
        remove_title_bar();
        hidecomponement();

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    public void remove_title_bar() {
        putClientProperty("Clients.isPalette", Boolean.TRUE);
        getRootPane().setWindowDecorationStyle(JRootPane.NONE);
        ((BasicInternalFrameUI) this.getUI()).setNorthPane(null);
        this.setBorder(null);
    }

    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        txt_idClient = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        txt_NomClient = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        txt_MontantApayer = new javax.swing.JTextField();
        jLabel4 = new javax.swing.JLabel();
        label_ccv = new javax.swing.JLabel();
        txt_ccv = new javax.swing.JTextField();
        txt_Date_expirationCarte = new javax.swing.JTextField();
        label_dateExpi = new javax.swing.JLabel();
        label_typeCarte = new javax.swing.JLabel();
        txt_nomTitulaireCarte = new javax.swing.JTextField();
        label_nomTitulaire = new javax.swing.JLabel();
        txt_totalPayer = new javax.swing.JTextField();
        jLabel9 = new javax.swing.JLabel();
        txt_totalRestant = new javax.swing.JTextField();
        jLabel10 = new javax.swing.JLabel();
        txt_typeCarteCredit = new javax.swing.JComboBox<>();
        txt_modePaiement = new javax.swing.JComboBox<>();
        PrintFacture = new javax.swing.JButton();
        EnvoyerDonnesPaiement = new javax.swing.JButton();
        AnnulerPaiements = new javax.swing.JButton();

        jPanel1.setBackground(new java.awt.Color(153, 153, 153));
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel1.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jLabel1.setText(" Matricule-Client");
        jPanel1.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 10, 210, 30));

        txt_idClient.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        txt_idClient.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txt_idClientKeyReleased(evt);
            }
        });
        jPanel1.add(txt_idClient, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 10, 180, 35));

        jLabel2.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jLabel2.setText(" Nom");
        jPanel1.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 50, 210, 30));

        txt_NomClient.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jPanel1.add(txt_NomClient, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 50, 180, 35));

        jLabel3.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jLabel3.setText(" Mode de paiement");
        jPanel1.add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 130, 210, 30));

        txt_MontantApayer.setEditable(false);
        txt_MontantApayer.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jPanel1.add(txt_MontantApayer, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 90, 180, 35));

        jLabel4.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jLabel4.setText(" Montant à payer");
        jPanel1.add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 90, 210, 30));

        label_ccv.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        label_ccv.setText(" CCV/CCV2");
        jPanel1.add(label_ccv, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 330, 210, 30));

        txt_ccv.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jPanel1.add(txt_ccv, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 330, 180, 35));

        txt_Date_expirationCarte.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jPanel1.add(txt_Date_expirationCarte, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 290, 180, 35));

        label_dateExpi.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        label_dateExpi.setText(" Date d'expiration (mm/yy)");
        jPanel1.add(label_dateExpi, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 290, -1, 30));

        label_typeCarte.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        label_typeCarte.setText(" Type de carte de crédit");
        jPanel1.add(label_typeCarte, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 240, 210, 30));

        txt_nomTitulaireCarte.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jPanel1.add(txt_nomTitulaireCarte, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 200, 180, 35));

        label_nomTitulaire.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        label_nomTitulaire.setText(" Nom du titulaire de carte");
        jPanel1.add(label_nomTitulaire, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 200, 210, 30));

        txt_totalPayer.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        txt_totalPayer.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txt_totalPayerKeyReleased(evt);
            }
        });
        jPanel1.add(txt_totalPayer, new org.netbeans.lib.awtextra.AbsoluteConstraints(730, 10, 180, 35));

        jLabel9.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jLabel9.setText(" Total payé");
        jPanel1.add(jLabel9, new org.netbeans.lib.awtextra.AbsoluteConstraints(480, 10, 210, 30));

        txt_totalRestant.setEditable(false);
        txt_totalRestant.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jPanel1.add(txt_totalRestant, new org.netbeans.lib.awtextra.AbsoluteConstraints(730, 50, 180, 35));

        jLabel10.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        jLabel10.setText(" Total Restant");
        jPanel1.add(jLabel10, new org.netbeans.lib.awtextra.AbsoluteConstraints(480, 60, 210, 30));

        txt_typeCarteCredit.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        txt_typeCarteCredit.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Visa", "MasterCard", " " }));
        jPanel1.add(txt_typeCarteCredit, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 240, 180, 40));

        txt_modePaiement.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        txt_modePaiement.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Espèce", "Carte Banquaire", "Chèque" }));
        txt_modePaiement.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                txt_modePaiementMouseReleased(evt);
            }
        });
        jPanel1.add(txt_modePaiement, new org.netbeans.lib.awtextra.AbsoluteConstraints(250, 133, 180, 40));

        PrintFacture.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        PrintFacture.setText("Imprimer le reçu");
        PrintFacture.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                PrintFactureActionPerformed(evt);
            }
        });
        jPanel1.add(PrintFacture, new org.netbeans.lib.awtextra.AbsoluteConstraints(260, 430, 180, 40));

        EnvoyerDonnesPaiement.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        EnvoyerDonnesPaiement.setText("Envoyer");
        EnvoyerDonnesPaiement.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                EnvoyerDonnesPaiementActionPerformed(evt);
            }
        });
        jPanel1.add(EnvoyerDonnesPaiement, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 430, 100, 40));

        AnnulerPaiements.setFont(new java.awt.Font("Noto Serif CJK HK Black", 0, 14)); // NOI18N
        AnnulerPaiements.setText("Annuler");
        AnnulerPaiements.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                AnnulerPaiementsActionPerformed(evt);
            }
        });
        jPanel1.add(AnnulerPaiements, new org.netbeans.lib.awtextra.AbsoluteConstraints(140, 430, 100, 40));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 1287, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 567, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents
    public void hidecomponement() {

        String modePaiement = (String) txt_modePaiement.getSelectedItem();

        if (modePaiement == "Carte Banquaire") {
            label_ccv.show();
            label_dateExpi.show();
            label_nomTitulaire.show();
            label_typeCarte.show();
            txt_Date_expirationCarte.show();
            txt_ccv.show();
            txt_nomTitulaireCarte.show();
            txt_typeCarteCredit.show();
        } else {
            label_ccv.hide();
            label_dateExpi.hide();
            label_nomTitulaire.hide();
            label_typeCarte.hide();
            txt_Date_expirationCarte.hide();
            txt_ccv.hide();
            txt_nomTitulaireCarte.hide();
            txt_typeCarteCredit.hide();
        }

    }
    private void EnvoyerDonnesPaiementActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_EnvoyerDonnesPaiementActionPerformed
        // TODO add your handling code here:
        if ("".equals(txt_idClient.getText()) || "".equals(txt_NomClient.getText()) || "".equals(txt_MontantApayer.getText()) || "".equals(txt_totalPayer.getText())) {
            JOptionPane.showMessageDialog(this, "Informations incomplètes !!!");
        } else {
            try {
                ps = con.prepareStatement("INSERT INTO paiements(client_id, modePaiement, montantApayer, montantRegler) VALUES (?, ?, ?, ?);");
                ps.setString(1, txt_idClient.getText());
                ps.setString(2, txt_modePaiement.getSelectedItem().toString());
                ps.setString(3, txt_MontantApayer.getText());
                ps.setString(4, txt_totalPayer.getText());
                ps.executeUpdate();

                JOptionPane.showMessageDialog(this, " \n Opération éffectuée avec succes !!! 😊😊😊😊\n");

            } catch (Exception e) {
                e.printStackTrace();
                JOptionPane.showMessageDialog(this, e);
            }
        }
    }//GEN-LAST:event_EnvoyerDonnesPaiementActionPerformed

    private void txt_totalPayerKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txt_totalPayerKeyReleased
        // TODO add your handling code here:
        double montant_total, total_paye, total_reste;
        total_paye = Double.parseDouble(txt_totalPayer.getText());

        if (total_paye < 0) {
            JOptionPane.showMessageDialog(null, "Attention montant Saisie négatif!");
        } else {
            try {
                //total_reste = Double.parseDouble(txt_totalRestant.getText());
                montant_total = Double.parseDouble(txt_MontantApayer.getText());
                total_reste = montant_total - total_paye;
                txt_totalRestant.setText("" + total_reste);
            } catch (Exception e) {
                JOptionPane.showMessageDialog(null, e);
                e.printStackTrace();
            }
        }
    }//GEN-LAST:event_txt_totalPayerKeyReleased

    private void txt_idClientKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txt_idClientKeyReleased
        try {
            // TODO add your handling code here:
            String sql = "SELECT cl.client_id, cl.nom,\n"
                    + "       COALESCE(cmb.prix_total, 0) + COALESCE(cmp.prix_total, 0) + COALESCE(ch.tarif, 0) AS 'montant_total'\n"
                    + "FROM clients cl\n"
                    + "LEFT JOIN consommationPlat cmp ON cl.client_id = cmp.client_id\n"
                    + "LEFT JOIN consommationBoisson cmb ON cmb.client_id = cl.client_id\n"
                    + "LEFT JOIN reservations r ON r.client_id = cl.client_id\n"
                    + "LEFT JOIN chambres ch ON ch.chambre_id = r.chambre_id WHERE cl.client_id LIKE ? ;";
            ps = con.prepareStatement(sql);
            ps.setString(1, txt_idClient.getText());
            rs = ps.executeQuery();
            while (rs.next()) {
                txt_NomClient.setText(rs.getString("nom"));
                txt_MontantApayer.setText(rs.getString("montant_total"));
            }
        } catch (SQLException ex) {
            Logger.getLogger(Paiements.class.getName()).log(Level.SEVERE, null, ex);
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, ex);
        }
    }//GEN-LAST:event_txt_idClientKeyReleased

    private void txt_modePaiementMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_txt_modePaiementMouseReleased
        // TODO add your handling code here:
        hidecomponement();
//        if (txt_modePaiement.getSelectedIndex() == 1) {
//            label_ccv.show();
//            label_dateExpi.show();
//            label_nomTitulaire.show();
//            label_typeCarte.show();
//            txt_Date_expirationCarte.show();
//            txt_ccv.show();
//            txt_nomTitulaireCarte.show();
//            txt_typeCarteCredit.show();
//        }
    }//GEN-LAST:event_txt_modePaiementMouseReleased

    private void PrintFactureActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_PrintFactureActionPerformed
        // TODO add your handling code here:
        try {
            int id = Integer.parseInt(txt_idClient.getText());
            JasperDesign jdesign = JRXmlLoader.load("/home/prince/hotelReports/recu.jrxml");
            Map<String, Object> para = new HashMap<String, Object>();
            para.put("id_client", id);
            JasperReport ireport = JasperCompileManager.compileReport(jdesign);
            JasperPrint jPrint = JasperFillManager.fillReport(ireport, para, con);
            JasperViewer.viewReport(jPrint, false);
        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(null, e.getMessage());
        }
    }//GEN-LAST:event_PrintFactureActionPerformed

    private void AnnulerPaiementsActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_AnnulerPaiementsActionPerformed
        // TODO add your handling code here:
        txt_Date_expirationCarte.setText("");
        txt_MontantApayer.setText("");
        txt_NomClient.setText("");
        txt_ccv.setText("");
        txt_idClient.setText("");
        txt_totalPayer.setText("");
        txt_totalRestant.setText("");
        txt_modePaiement.setSelectedItem(null);
    }//GEN-LAST:event_AnnulerPaiementsActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton AnnulerPaiements;
    private javax.swing.JButton EnvoyerDonnesPaiement;
    private javax.swing.JButton PrintFacture;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JLabel label_ccv;
    private javax.swing.JLabel label_dateExpi;
    private javax.swing.JLabel label_nomTitulaire;
    private javax.swing.JLabel label_typeCarte;
    private javax.swing.JTextField txt_Date_expirationCarte;
    private javax.swing.JTextField txt_MontantApayer;
    private javax.swing.JTextField txt_NomClient;
    private javax.swing.JTextField txt_ccv;
    private javax.swing.JTextField txt_idClient;
    private javax.swing.JComboBox<String> txt_modePaiement;
    private javax.swing.JTextField txt_nomTitulaireCarte;
    private javax.swing.JTextField txt_totalPayer;
    private javax.swing.JTextField txt_totalRestant;
    private javax.swing.JComboBox<String> txt_typeCarteCredit;
    // End of variables declaration//GEN-END:variables
}
